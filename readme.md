# Well-instrumented Serverless Application 
### AWS Lambda + AWS API Gateway + Express + New Relic Browser

This project is designed to show instrumentation best practices for a customer-facing serverless application. It includes:
* An example Express.js application using the `aws-serverless-express` project.
* AWS CodeDeploy hooks to automatically roll back a deployment if front-end JavaScript errors are detected.
* Real-user monitoring with New Relic Browser.
* Low-volume synthetic browser traffic generated by Amazon Cloudwatch Events.

### requirements

* AWS Account
* New Relic Account with Browser
* New Relic Insights Query Key

### additional instrumentation included

**Custom Metrics**
* Time to interactive (frontend)
* Time to hero image (frontend)

**Custom Facets**
* Deployed function version (i.e. backend deployed version)

### setup

Install dependencies:
```
   $ cd express-app
   $ npm install
```

Set Amazon S3 bucket name to store packaged code artifacts:
```
   $ export LAMBDA_BUCKET_NAME=<<name of an s3 bucket to store function package>>
```

### packaging

Package the AWS SAM application using the [AWS SAM Local](https://github.com/awslabs/aws-sam-local) tool:
```
    $ sam package --template-file template.yaml --s3-bucket $LAMBDA_BUCKET_NAME --output-template-file packaged.yaml
```

### deploying

A New Relic account and [New Relic Insights Query Key](https://docs.newrelic.com/docs/insights/insights-api/get-data/query-insights-event-data-api) is required.

```
    $ sam deploy --template-file ./packaged.yaml --stack-name lambda-stack-postdeploy --capabilities CAPABILITY_NAMED_IAM --parameter-overrides "NRAccountId=<<account id>>" "NRInsightsQueryKey=<<insights query key>>"
```
