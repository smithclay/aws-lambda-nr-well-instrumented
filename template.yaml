AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: AWS Lambda + AWS API Gateway + Express + New Relic Browser

Parameters:
  BucketName:
    Type: String
    Default: aws-lambda-nr-postdeploy
  NRAccountId:
    Type: String
  NRInsightsQueryKey:
    Type: String

Resources:
  ApiGatewayApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: Prod
      Cors: "'*'"

      DefinitionBody:
          'Fn::Transform':
            Name: 'AWS::Include'
            Parameters:
              Location: !Sub 's3://${BucketName}/swagger.yaml'

  LambdaFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./express-app
      Handler: index.handler
      Runtime: nodejs6.10
      Timeout: 30
      MemorySize: 512
      AutoPublishAlias: live
      DeploymentPreference:
        Type: AllAtOnce
        Hooks:
          PostTraffic: !Ref PostTrafficHookFunction
      Events:
        ProxyApiRoot:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGatewayApi
            Path: /
            Method: ANY

  PostTrafficHookFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./post-traffic-hook
      Handler: index.handler
      Policies:
        - Version: "2012-10-17"
          Statement:
          - Effect: "Allow"
            Action:
              - "codedeploy:PutLifecycleEventHookExecutionStatus"
            Resource:
              !Sub 'arn:aws:codedeploy:${AWS::Region}:${AWS::AccountId}:deploymentgroup:${ServerlessDeploymentApplication}/*'
        - Version: "2012-10-17"
          Statement:
          - Effect: "Allow"
            Action:
              - "lambda:InvokeFunction"
            Resource: !Ref LambdaFunction.Version
      Runtime: nodejs6.10
      FunctionName: 'CodeDeployHook_postTrafficHook'
      DeploymentPreference:
        Enabled: false
      Environment:
        Variables:
          CurrentVersion: !Ref LambdaFunction.Version
          NEWRELIC_INSIGHTS_QUERY_KEY: !Ref NRInsightsQueryKey
          NEWRELIC_ACCOUNT_ID: !Ref NRAccountId

Outputs:
  ApiUrl:
    Description: URL of your API endpoint
    Value: !Join
      - ''
      - - https://
        - !Ref ApiGatewayApi
        - '.execute-api.'
        - !Ref 'AWS::Region'
        - '.amazonaws.com/Prod'